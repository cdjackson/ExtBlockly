<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ExtJS Blockly Demo</title>

    <link rel="stylesheet" type="text/css" href="ext-theme-classic-all.css"/>
    <script type="text/javascript" src="ext-all-debug.js"></script>

    <script type="text/javascript" src="../core/blockly.js"></script>
    <script type="text/javascript" src="../core/block.js"></script>
    <script type="text/javascript" src="../core/block_svg.js"></script>
    <script type="text/javascript" src="../core/blocks.js"></script>
    <script type="text/javascript" src="../core/icon.js"></script>
    <script type="text/javascript" src="../core/bubble.js"></script>
    <script type="text/javascript" src="../core/comment.js"></script>
    <script type="text/javascript" src="../core/connection.js"></script>
    <script type="text/javascript" src="../core/contextmenu.js"></script>
    <script type="text/javascript" src="../core/css.js"></script>
    <script type="text/javascript" src="../core/field.js"></script>
    <script type="text/javascript" src="../core/field_textinput.js"></script>
    <script type="text/javascript" src="../core/field_angle.js"></script>
    <script type="text/javascript" src="../core/field_checkbox.js"></script>
    <script type="text/javascript" src="../core/field_colour.js"></script>
    <script type="text/javascript" src="../core/field_dropdown.js"></script>
    <script type="text/javascript" src="../core/field_image.js"></script>
    <script type="text/javascript" src="../core/field_label.js"></script>
    <script type="text/javascript" src="../core/field_variable.js"></script>
    <script type="text/javascript" src="../core/flyout.js"></script>
    <script type="text/javascript" src="../core/generator.js"></script>
    <script type="text/javascript" src="../core/inject.js"></script>
    <script type="text/javascript" src="../core/input.js"></script>
    <script type="text/javascript" src="../core/msg.js"></script>
    <script type="text/javascript" src="../core/mutator.js"></script>
    <script type="text/javascript" src="../core/names.js"></script>
    <script type="text/javascript" src="../core/procedures.js"></script>
    <script type="text/javascript" src="../core/scrollbar.js"></script>
    <script type="text/javascript" src="../core/toolbox.js"></script>
    <script type="text/javascript" src="../core/tooltip.js"></script>
    <script type="text/javascript" src="../core/trashcan.js"></script>
    <script type="text/javascript" src="../core/utils.js"></script>
    <script type="text/javascript" src="../core/variables.js"></script>
    <script type="text/javascript" src="../core/warning.js"></script>
    <script type="text/javascript" src="../core/widgetdiv.js"></script>
    <script type="text/javascript" src="../core/workspace.js"></script>
    <script type="text/javascript" src="../core/xml.js"></script>

    <script type="text/javascript" src="../blocks/colour.js"></script>
    <script type="text/javascript" src="../blocks/lists.js"></script>
    <script type="text/javascript" src="../blocks/logic.js"></script>
    <script type="text/javascript" src="../blocks/loops.js"></script>
    <script type="text/javascript" src="../blocks/math.js"></script>
    <script type="text/javascript" src="../blocks/procedures.js"></script>
    <script type="text/javascript" src="../blocks/text.js"></script>
    <script type="text/javascript" src="../blocks/variables.js"></script>

    <script type="text/javascript" src="../msg/js/en.js"></script>
</head>
<body>

<xml id="xxx">
    <block type="controls_if"></block>
</xml>

<xml id="toolbox" style="display: none">
    <block type="controls_if"></block>
    <block type="controls_repeat_ext"></block>
    <block type="logic_compare"></block>
    <block type="math_number"></block>
    <block type="math_arithmetic"></block>
    <block type="text"></block>
    <block type="text_print"></block>
</xml>

<xml id="go">
    <block type="controls_if" id="26" inline="false" x="54" y="25">
        <value name="IF0">
            <block type="logic_compare" id="94" inline="true">
                <field name="OP">EQ</field>
                <value name="A">
                    <block type="variables_get" id="102">
                        <field name="VAR">item</field>
                    </block>
                </value>
                <value name="B">
                    <block type="variables_get" id="105">
                        <field name="VAR">item</field>
                    </block>
                </value>
            </block>
        </value>
        <statement name="DO0">
            <block type="controls_repeat_ext" id="17" inline="true">
                <value name="TIMES">
                    <block type="math_number" id="18">
                        <field name="NUM">10</field>
                    </block>
                </value>
                <statement name="DO">
                    <block type="variables_set" id="56" inline="true">
                        <field name="VAR">item</field>
                        <value name="VALUE">
                            <block type="math_arithmetic" id="75" inline="true">
                                <field name="OP">ADD</field>
                                <value name="A">
                                    <block type="variables_get" id="78">
                                        <field name="VAR">item</field>
                                    </block>
                                </value>
                                <value name="B">
                                    <block type="variables_get" id="86">
                                        <field name="VAR">item</field>
                                    </block>
                                </value>
                            </block>
                        </value>
                    </block>
                </statement>
            </block>
        </statement>
    </block>
</xml>

<script>
    var svgArray = [
        {block: "<xml><block type='controls_if'></block></xml>", name: "X"},
        {block: "<xml><block type='controls_if'><mutation elseif='1'></mutation></block></xml>", name: "X"},
        {block: "<xml><block type='math_arithmetic'></block></xml>", name: "X"},
        {block: "<xml><block type='controls_repeat_ext'></block></xml>", name: "X"},
        {block: "<xml><block type='variables_set'></block></xml>", name: "X"}
    ];

    Ext.require([
        'Ext.window.Window',
        'Ext.tab.*',
        'Ext.toolbar.Spacer',
        'Ext.layout.container.Card',
        'Ext.layout.container.Border'
    ]);

    Ext.onReady(function () {
        var cc = Blockly.Xml.textToDom("<xml><block type='controls_if'>xxx</block></xml>");

// Create the item format store
        var store = Ext.create('Ext.data.ArrayStore', {
            fields: [
                {name: 'block'},
                {name: 'svg'},
                {name: 'name'}
            ]
        });
        store.loadData(svgArray);

        function initializeBlockDragZone(v) {
            v.dragZone = Ext.create('Ext.dd.DragZone', v.getEl(), {

//      On receipt of a mousedown event, see if it is within a draggable element.
//      Return a drag data object if so. The data object can contain arbitrary application
//      data, but it should also contain a DOM element in the ddel property to provide
//      a proxy to drag.
                getDragData: function (e) {
                    var sourceEl = e.getTarget("svg", 10);
                    if (sourceEl) {
                        var d = sourceEl.cloneNode(true);
                        d.id = Ext.id();
                        return v.dragData = {
                            sourceEl: sourceEl,
                            repairXY: Ext.fly(sourceEl).getXY(),
                            ddel: d,
                            patientData: v.record.get("block")
                        };
                    }
                },

//      Provide coordinates for the proxy to slide back to on failed drag.
//      This is the original XY coordinates of the draggable element.
                getRepairXY: function () {
                    return this.dragData.repairXY;
                }
            });


//        grid.dropZone =
            Ext.create('Ext.dd.DropZone', "blocklyHere", {

//      If the mouse is over a target node, return that node. This is
//      provided as the "target" parameter in all "onNodeXXXX" node event handling functions
                getTargetFromEvent: function (e) {
                    console.log("node in");
                //    var xx = win.getItems();
                        win.fireEvent("mousemove", {clientX: e.xy[0], clientY: e.xy[1]});
//                    Blockly.fireUiEvent(document, 'mousemove');
//                    Blockly.onMouseMove_();
                    return e.getTarget('#blocklyHere');
                },

//      On entry into a target node, highlight that node.
             //   onNodeEnter: function (target, dd, e, data) {
           //         console.log("node in");
//                Ext.fly(target).addCls('hospital-target-hover');
         //       },

//      On exit from a target node, unhighlight that node.
         //       onNodeOut: function (target, dd, e, data) {
           //         console.log("node out");
//                Ext.fly(target).removeCls('hospital-target-hover');
             //   },

//      While over a target node, return the default drop allowed class which
//      places a "tick" icon into the drag proxy.
 //               onNodeOver: function (target, dd, e, data) {
   //                 console.log("can we drop?");
     //               return Ext.dd.DropZone.prototype.dropAllowed;
       //         },

//      On node drop, we can interrogate the target node to find the underlying
//      application object that is the real target of the dragged data.
//      In this case, it is a Record in the GridPanel's Store.
//      We can use the data set up by the DragZone's getDragData method to read
//      any data we decided to attach.
                onNodeDrop: function (target, dd, e, data) {
//                var rowBody = Ext.fly(target).findParent('.x-grid-rowbody-tr', null, false),
//                        mainRow = rowBody.previousSibling,
//                        h = gridView.getRecord(mainRow),
//                        targetEl = Ext.get(target);

//                targetEl.update(data.patientData.name + ', ' + targetEl.dom.innerHTML);
//                        Ext.Msg.alert('Drop gesture', 'Dropped patient ' + data.patientData.name +
//                        ' on hospital ' + h.data.name);
                    Ext.Msg.alert('Drop gesture', 'Dropped block');

                    if (record == null)
                        return;

                    var cc = Blockly.Xml.textToDom(data.patientData);
                    Blockly.Xml.domToBlock(Blockly.mainWorkspace, cc.childNodes[0]);

                    return true;
                }
            });
        }

        var itemsList = Ext.create('Ext.grid.Panel', {
            header: false,
            hideHeaders: true,
            store: store,
            collapsible: false,
            multiSelect: false,
//            viewConfig: {
//                plugins: {
//                    ptype: 'gridviewdragdrop',
//                    dragGroup: 'firstGridDDGroup',
//                    dropGroup: 'secondGridDDGroup'
//                }
//            },
            columns: [
                {
                    text: "X",
                    flex: 1,
                    dataIndex: 'type',
                    renderer: function (value, metadata, record, row, col, store, gridView) {
                        var cc = Blockly.Xml.textToDom(record.get("block"));
                        var block = Blockly.Xml.domToBlock(Blockly.mainWorkspace, cc.childNodes[0]);

                        var xx = '<svg height="' + block.getHeightWidth().height + '">' + block.getSvgRoot().outerHTML + "</svg>";
                        record.set('svg',xx);

                        Blockly.mainWorkspace.clear();
                        Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, document.getElementById('go'));

                        return xx;
                    }
                }
            ],
            listeners: {
                    render: initializeBlockDragZone
                ,
                itemdblclick: function (grid, record) {
                    if (record == null)
                        return;

                    var cc = Blockly.Xml.textToDom(record.get("block"));
                    Blockly.Xml.domToBlock(Blockly.mainWorkspace, cc.childNodes[0]);
                }
            }
        });


        var win = Ext.create('widget.window', {
            title: 'Layout Window',
            closable: true,
            closeAction: 'hide',
            //animateTarget: this,
            width: 600,
            height: 350,
            layout: 'border',
 /*           viewConfig: {
                plugins: {
                    ptype: 'gridviewdragdrop',
                    dragGroup: 'secondGridDDGroup',
                    dropGroup: 'firstGridDDGroup'
                },
                listeners: {
                    drop: function (node, data, dropRec, dropPosition) {
                        var dropOn = dropRec ? ' ' + dropPosition + ' ' + dropRec.get('name') : ' on empty view';
                        console.log("Drag from left to right", 'Dropped ' + data.records[0].get('name') + dropOn);
                    }
                }
            },*/
            items: [
                {
                    region: 'west',
//                    title: 'Navigation',
                    width: 200,
                    split: true,
                    collapsible: true,
                    floatable: false,
                    //                       layout:{
                    //                         type:'accordion',
                    //                       hideCollapseTool:true
                    //                 }
//                    ,items:["1","2"]
                    items: [itemsList]

                },
                {
                    region: 'center',
                    layout: 'fit',
                    html: '<div id="blocklyHere"></div>',
                    listeners: {
                        afterrender: function () {
                            Blockly.inject(document.getElementById('blocklyHere'), {path: '../', trashcan: true});
                        },
                        resize: function (panel, width, height, oldWidth, oldHeight, eOpts) {
                            var b = panel.getBox();
                            var w = panel.getWidth();
                            var c = panel.child("#blocklyHere");
                            var dd = document.getElementById('blocklyHere');
                            Blockly.resizeWindow(width, height);
//                            Blockly.resizeWindow(width - 12, height - 35);
                        },
                        move: function (panel, x, y) {
                            Blockly.setClientPosition(x, y);
                        }
                    }
                }
            ]
        }).show();
    });


    //      Blockly.inject(document.getElementById('blocklyDiv'), {path: '../', toolbox: document.getElementById('toolbox')});
</script>

</body>
</html>
